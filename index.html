/**
 * Web App - Recebe dados do formulário de anamnese
 * Salva em planilha e retorna JSON de confirmação
 */

const SECRET = 'nm_2025_24jun86_bynv';   // mesmo que no HTML
const SHEET_NAME = 'Respostas';          // ajuste para o nome da aba da planilha

function doPost(e) {
  try {
    if (!e || !e.parameter) {
      return _resp({ ok: false, error: 'Nenhum dado recebido' });
    }

    // valida segredo
    const secret = e.parameter.secret;
    if (secret !== SECRET) {
      return _resp({ ok: false, error: 'Token inválido' });
    }

    // parse do payload
    const payload = JSON.parse(e.parameter.payload);
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
    if (!sheet) {
      return _resp({ ok: false, error: `Aba ${SHEET_NAME} não encontrada` });
    }

    // monta linha (ajuste a ordem se quiser)
    const now = new Date();
    const row = [
      now,
      payload.nome || '',
      payload.nascimento || '',
      payload.telefone || '',
      payload.email || '',
      payload.profissao || '',
      (payload.objetivos || []).join(', '),
      payload.objetivoOutro || '',
      (payload.procInteresse || []).join(', '),
      payload.faixaInvest || '',
      payload.jaFez || '',
      payload.quaisFez || '',
      payload.jaPaciente || '',
      payload.alergiaMedicamentos || '',
      payload.quaisAlergiaMedicamentos || '',
      payload.alergiasGerais || '',
      payload.quaisAlergias || '',
      payload.usaMedicamentos || '',
      payload.quaisMedicamentos || '',
      (payload.doencas || []).join(', '),
      payload.gestante || '',
      payload.anabolizantes || '',
      payload.quaisAnabolizantes || '',
      payload.cirurgiaRecente || '',
      payload.quaisCirurgias || '',
      payload.tabagismo || '',
      payload.tabagismoDetalhes || '',
      payload.alcool || '',
      payload.alcoolDetalhes || '',
      payload.atividadeFisica || '',
      payload.atividadeFisicaDetalhes || '',
      payload.lgpd ? 'Sim' : 'Não',
      payload.selfieFrontDataURL ? 'Anexada' : '',
      payload.selfieLeftDataURL ? 'Anexada' : '',
      payload.selfieRightDataURL ? 'Anexada' : '',
      payload.utm_source || '',
      payload.utm_medium || '',
      payload.utm_campaign || '',
      payload.utm_content || '',
      payload.utm_term || '',
      payload.ua || '',
      payload.ip || ''
    ];

    sheet.appendRow(row);

    // resposta de sucesso
    const response = {
      ok: true,
      whatsapp: "https://wa.me/5531999999999?text=Obrigada+por+enviar+sua+anamnese%21"
    };
    return _resp(response);

  } catch (err) {
    return _resp({ ok: false, error: err.message });
  }
}

// helper para resposta JSON
function _resp(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}
